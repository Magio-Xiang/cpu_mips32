# OpenMIPS学习笔记

## Chapter3  
- 五级流水线：取指、译码、执行、访存、回写  
- 指令的5个阶段  
    1.取指令阶段 IF (使用PC(Program counter)寄存器组和存储器)   
        取指令(Instruction Fetch，IF)阶段是将一条指令从主存中取到指令寄存器的过程。程序计数器PC中的数值，用来指示当前指令在主存中的位置。当一条指令被取出后，PC中的数值将根据指令字长度而自动递增：若为单字长指令，则(PC)+1 -> PC；若为双字长指令，则(PC)+2 -> PC，依此类推。    

    2.指令译码阶段 ID (指令寄存器组):  
        取出指令后，计算机当即进入指令译码(Instruction Decode，ID)阶段。在指令译码阶段，指令译码器按照预约的指令格式，对取回的指令进行拆分和解释，识别区分出不一样的指令类别以及各类获取操做数的方法。在组合逻辑控制的计算机中，指令译码器对不一样的指令操做码产生不一样的控制电位，以造成不一样的微操做序列；在微程序控制的计算机中，指令译码器用指令操做码来找到执行该指令的微程序的入口，并今后入口开始执行。    

    3.执行指令阶段 EX (ALU算术逻辑单元)  
        在取指令和指令译码阶段以后，接着进入执行指令(Execute，EX)阶段。此阶段的任务是完成指令所规定的各类操做，具体实现指令的功能。为此，CPU的不一样部分被链接起来，以执行所需的操做。例如，若是要求完成一个加法运算，算术逻辑单元ALU将被链接到一组输入和一组输出，输入端提供须要相加的数值，输出端将含有最后的运算结果。    

    4.访存取数阶段 MEM   
        根据指令须要，有可能要访问主存，读取操做数，这样就进入了访存取数(Memory，MEM)阶段。    此阶段的任务是：根据指令地址码，获得操作数在主存中的地址，并从主存中读取该操做数用于运算。  

    5.结果写回阶段 WB (寄存器组)    
        做为最后一个阶段，结果写回(Writeback，WB)阶段把执行指令阶段的运行结果数据“写回”到某种存储形式：结果数据常常被写到CPU的内部寄存器中，以便被后续的指令快速地存取；在有些状况下，结果数据也可被写入相对较慢、但较廉价且容量较大的主存。许多指令还会改变程序状态字寄存器中标志位的状态，这些标志位标识着不一样的操做结果，可被用来影响程序的动做。  


## Chapter4 第一条ori指令实现
- ori指令格式
    - 31：26：指令码 ORI：6'b001101
    - 25：21：寄存器rs
    - 20：16：寄存器rt
    - 15：0：立即数 immediate
- ori指令作用：将16位立即数immediate无符号扩展到32位，与rs寄存器值进行逻辑或运算，再存到rt寄存器中  
- 无符号扩展：高位全部置零；符号扩展：高位全部置原数据最高位
- 状态机与流水线  
    - 状态机：寄存器的输出端和输入端存在环路
    - 流水线：寄存器之间有连接，没有上述环路
- RTL：Register Transfer Level 寄存器传输级
- PC模块
    - 给出指令地址
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用             | 
    | ----------- | ----------- | -----------   | -----------      | 
    | rst         | 1           |输入           |复位信号           | 
    | clk         |1            | 输入          |时钟信号           | 
    | pc          |32           |输出           |要读取的指令地址    | 
    | ce          |1            | 输出          |指令存储器使能信号  | 
    - OpenMIPS按照字节寻址，一条指令对应4个字节，32位，每时钟周期PC自加4 

- IF/ID模块
    - 暂存取指阶段的指令及地址，在下一个时钟传到译指阶段
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用                      | 
    | ----------- | ----------- | -----------   | -----------               | 
    | rst         | 1           |输入           |复位信号                    | 
    | clk         |1            | 输入          |时钟信号                    | 
    | if_pc       |32           |输入           |取指阶段得到的指令地址       | 
    | if_inst     |32           |输入           |取指阶段得到的指令           | 
    | id_pc       |32           |输出           |译码阶段的指令地址           | 
    | id_inst     |32           | 输出          |译码阶段的指令               | 
    - 时钟缓冲电路 

- Regfile模块 
    - 实现32个32位通用寄存器，可以同时执行两个寄存器的读操作和一个寄存器的写操作 
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用                      | 
    | ----------- | ----------- | -----------   | -----------               | 
    | rst         | 1           |输入           |复位信号                    | 
    | clk         |1            |输入           |时钟信号                    | 
    | we          |1            |输入           |写使能                     |     
    | waddr       |5            |输入           |写寄存器地址                 | 
    | wdata       |32           |输入           |写入数据                    | 
    | re1         |1            |输入           |第一个寄存器读使能          | 
    | raddr1      | 5           |输入           |第一个寄存器读地址           | 
    | rdata1      |32           |输出           |第一个寄存器读输出数据        | 
    | re2         |1            |输入           |第二个寄存器读使能            | 
    | raddr2      |5            |输入           |第二个寄存器读地址            | 
    | rdata2      |32           |输出           |第二个寄存器读输出数据         | 
    - $0寄存器规定值只能为0，不能写入，读取时直接读0 
    - 读寄存器为组合逻辑，不需要时钟周期，立即读出 
    - 写寄存器为时序逻辑操作，需要一个时钟周期 

- ID模块 
    - 对指令进行译码，得到运算类型、子类型、源操作数1和2、要写入的寄存器信息 
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用                      | 
    | ----------- | ----------- | -----------   | -----------               | 
    | rst         | 1           |输入           |复位信号                    | 
    | pc_i        |32           |输入           |指令地址                    | 
    | inst_i      |32           |输入           |指令                        | 
    | reg1_data_i |32           |输入           |第一个寄存器端口输入         | 
    | reg2_data_i |32           |输入           |第二个寄存器端口输入         | 
    | reg1_read_o |1            |输出           |第一个寄存器读使能          | 
    | reg2_read_o | 1           |输出           |第二个寄存器读使能           | 
    | reg1_addr_o |5            |输出           |第一个寄存器地址            | 
    | reg2_addr_o |5            |输出           |第二个寄存器地址            | 
    | aluop_o     |8            |输出           |运算子类型                        | 
    | alusel_o    |3            |输出           |运算类型           | 
    | reg1_o      |32           |输出           |运算的源操作数1               | 
    | reg2_o      |32           |输出           |运算的源操作数2             | 
    | wd_o        |5            |输出           |输出结果要写入的目的寄存器地址   | 
    | wreg_o      |1            |输出           |输出结果是否要写入目的寄存器       |  
    - 源操作数可以来自寄存器或者立即数 
    - 运算类型由两个参数决定，alusel_o决定运算类型包括逻辑运算、移位运算、算术运算等，aluop_o决定子类型，对逻辑运算而言包括或与非异或等 

- ID/EX模块 
    - 暂存译指阶段的运算类型、源操作数、目的寄存器信息，在下一个时钟传到执行阶段 
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用                      | 
    | ----------- | ----------- | -----------   | -----------               | 
    | rst         | 1           |输入           |复位信号                    | 
    | clk         |1            |输入           |时钟信号                    | 
    | id_aluop    |8            |输入           |译码阶段的指令要进行的运算子类型                   | 
    | id_alusel   |3            |输入           |译码阶段的指令要进行的运算类型                    | 
    | id_reg1     |32           |输入           |译码阶段的指令要进行的运算源操作数1                   | 
    | id_reg2     |32           |输入           |译码阶段的指令要进行的运算源操作数2                   | 
    | id_wd       | 5           |输入           |译码阶段的指令要写入的目的寄存器地址                | 
    | id_wreg     |1            |输出           |译码阶段的指令是否写入目的寄存器            | 
    | ex_aluop    |8            |输出           |执行阶段的指令要进行的运算子类型                  | 
    | ex_alusel   |3            |输出           |执行阶段的指令要进行的运算类型                          | 
    | ex_reg1     |32           |输出           |执行阶段的指令要进行的运算源操作数1          | 
    | ex_reg2     |32           |输出           |执行阶段的指令要进行的运算源操作数2                     | 
    | ex_wd       | 5           |输出           |执行阶段的指令要写入的目的寄存器地址              | 
    | ex_wreg     |1            |输出           |执行阶段的指令是否写入目的寄存器       | 
    - 时钟缓冲作用 

- EX模块 
    - 对源操作数1、2进行指定运算 
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用                      | 
    | ----------- | ----------- | -----------   | -----------               | 
    | rst         | 1           |输入           |复位信号                    | 
    | alusel_i    |3            |输入           |运算类型                    | 
    | aluop_i     |8            |输入           |运算子类型                    | 
    | reg1_i      |32           |输入           |源操作数1                   | 
    | reg2_i      |32           |输入           |源操作数2                   | 
    | wd_i        |5            |输入           |要写入的目的寄存器地址        | 
    | wreg_i      | 1           |输入           |是否要写入目的寄存器          | 
    | wd_o        |5            |输出           |执行阶段的指令要写入的目的寄存器地址        | 
    | wreg_o      |1            |输出           |执行阶段的指令是否要写入目的寄存器          | 
    | wdata_o     |32           |输出           |执行阶段的指令要写入目的寄存器的值          | 

    - 纯组合逻辑，先进行子运算，再进行最终运算 

- EX/MEM模块 
    - 暂存处理阶段的运算结果、要写入目的寄存器信息，在下一个时钟传到访存阶段 
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用                      | 
    | ----------- | ----------- | -----------   | -----------               | 
    | rst         | 1           |输入           |复位信号                    | 
    | clk         |1            |输入           |时钟信号                    | 
    | ex_wd       | 5           |输入           |执行阶段的指令要写入的目的寄存器地址                | 
    | ex_wreg     |1            |输入           |执行阶段的指令是否写入目的寄存器            | 
    | ex_wdata    |32           |输入           |执行阶段的指令得到的运算结果                  | 
    | mem_wdata   |32           |输出           |访存阶段的指令得到的运算结果                          | 
    | mem_wd      | 5           |输出           |访存阶段的指令要写入的目的寄存器地址              | 
    | mem_wreg    |1            |输出           |访存阶段的指令是否写入目的寄存器       | 
    - 时钟缓冲作用 


- MEM模块 
    - 访存阶段 
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用                      | 
    | ----------- | ----------- | -----------   | -----------               | 
    | rst         | 1           |输入           |复位信号                    | 
    | wd_i        |5            |输入           |访存阶段的指令要写入的目的寄存器地址        | 
    | wreg_i      | 1           |输入           |访存阶段的指令是否要写入目的寄存器          | 
    | wdata_i     |32           |输入           |访存阶段的指令要写入目的寄存器的值          | 
    | wd_o        |5            |输出           |访存阶段的指令最终要写入的目的寄存器地址        | 
    | wreg_o      |1            |输出           |访存阶段的指令最终是否要写入目的寄存器          | 
    | wdata_o     |32           |输出           |访存阶段的指令最终要写入目的寄存器的值          | 

    - 目前ori指令本阶段不需要执行操作，简单传递 

- MEM/WB模块 
    - 暂存访存阶段的运算结果，在下一个时钟传到回写阶段 
    - 接口 

    | 接口名       | 宽度（bit） | 输入/输出      | 作用                      | 
    | ----------- | ----------- | -----------   | -----------               | 
    | rst         | 1           |输入           |复位信号                    | 
    | clk         |1            |输入           |时钟信号                    | 
    | mem_wd      | 5           |输入           |访存阶段的指令要写入的目的寄存器地址                | 
    | mem_wreg    |1            |输入           |访存阶段的指令是否写入目的寄存器            | 
    | mem_wdata   |32           |输入           |访存阶段的指令得到的运算结果                  | 
    | wb_wdata    |32           |输出           |回写阶段的指令得到的运算结果                          | 
    | wb_wd       | 5           |输出           |回写阶段的指令要写入的目的寄存器地址              | 
    | wb_wreg     |1            |输出           |回写阶段的指令是否写入目的寄存器       | 
    - 时钟缓冲作用 

- MIPS编译环境建立 
    - 使用MIPS32架构下已有的GNU工具链 
    - 虚拟机安装： 
        - VisualBox：最新版本即可 
        - Ubuntu：使用22.04desktop版本 
        - 共享文件夹设置 
    - GNU工具链安装： 
        - 参考链接：https://blog.csdn.net/qq_38305370/article/details/114676603
        - 工具链命令：mips-linux-gnu- 
        - 流程：inst_rom.s编译->inst_rom.o链接ram.ld->inst_rom.om格式转化->inst_rom.bin转化格式->inst_rom.data 
        - Makefile：集成脚本 命令：make all
